library(scRepertoire)
library(Seurat)
library(dplyr)
library(ggplot2)
library(patchwork)
library(stringr)
library(immunarch)
library(purrr)
library(ineq)
library(circlize)
library(scales)


#Figures S5A-D - CD8 TCR clonality analysis, requires output from Figure 5.
#Figure S5A - Gini index by tissue
combined_df <- map2_dfr(combined, names(combined), ~mutate(.x, sample = .y))

combined_df <- combined_df %>%
  mutate(Group = case_when(
    grepl("Kidney", sample) ~ "Kidney",
    grepl("Spleen", sample) ~ "Spleen",
    grepl("rLN", sample) ~ "rLN",
    TRUE ~ "Other"
  ))

gini_by_group <- combined_df %>%
  filter(!is.na(CTaa)) %>%
  group_by(Group) %>%
  summarise(
    gini = Gini(table(CTaa))
  )

print(gini_by_group)

ggplot(gini_by_group, aes(x = Group, y = gini, fill = Group)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  ylab("Gini Coefficient") +
  xlab("Tissue Type") +
  ggtitle("Clonal Diversity by Gini Index") +
  scale_y_continuous(limits = c(0, 0.7))


#Figure S5B - Top expanded clones by cluster
clonalCompare(
  combined,
  top.clones = 10,
  samples = c("rLN", "Spleen", "Kidney"),
  cloneCall = "aa",
  graph = "alluvial"
)

clones_of_interest <- c(
  "CAAPDYSNNRLTL_CASSWGTGTGNTLYF", "CAMGDTNAYKVIF_CASSHTTASYEQYF",
  "CIVTGSGGNYKPTF_CGAREDSAETLYF", "CAMRERVASSSFSKLVF_CASSPDWGSQNTLYF",
  "CALSGMPNYNVLYF_CASSLRDWGAEQFF", "CALSDRGGRALIF;CAVRGYGGSGNKLIF_CGVPGQGYEQYF",
  "CALGRSNTDKVVF_CASGDAGGASQNTLYF", "CADSAGNKLTF;CAAMPNYNVLYF_CASSIEGNSDYTF",
  "NA_CASSWGTGTGNTLYF", "CAVIDTNAYKVIF_CASSTEQYF",
  "CAMDNTGNYKYVF_CAWSLDGSPLYF", "NA_CAWSLLGDSYEQYF",
  "CAASELPNYNVLYF_CASSDAGGPAETLYF", "CALSEGNMGYKLTF_CAWSLLGDSYEQYF",
  "CALSRSSNTDKVVF_CASSFPGYNYAEQFF"
)

filtered_seurat <- subset(seurat, subset = CTaa %in% clones_of_interest)

clonalCompare(
  filtered_seurat,
  top.clones = 10,    
  cloneCall = "aa",   
  graph = "alluvial"  
)


#Figure S5C - Top expanded clones by mouse
contig_list <- list(
  contigs_01 = read.csv("contigs_01.csv"),
  contigs_33 = read.csv("contigs_33.csv"),
  contigs_34 = read.csv("contigs_34.csv"),
  contigs_43 = read.csv("contigs_43.csv"),
  contigs_44 = read.csv("contigs_44.csv"),
  contigs_47 = read.csv("contigs_47.csv"),
  contigs_48 = read.csv("contigs_48.csv")
)


contig_list <- list(
  contigs_01 = read.csv("contigs_01.csv"),
  contigs_33_34 = read.csv("combined_contigs_33_34.csv"),
  contigs_43_44 = read.csv("combined_contigs_43_44.csv"),
  contigs_47_48 = read.csv("combined_contigs_47_48.csv")
)

combined <- combineTCR(
  contig_list,
  samples = names(contig_list),       
  ID = rep("Project1", length(contig_list))
)

vizGenes(combined, 
         x.axis = "TRBV", 
         y.axis = NULL)

vizGenes(combined, 
         x.axis = "TRAV", 
         y.axis = NULL)


all_tcrs <- bind_rows(combined, .id = "sample")

top_100_clones <- all_tcrs %>%
  group_by(CTaa) %>%
  summarise(freq = n(), .groups = "drop") %>%
  arrange(desc(freq)) %>%
  slice_head(n = 100) %>%
  pull(CTaa)

top_clone_data <- all_tcrs %>%
  filter(CTaa %in% top_100_clones)

clone_counts <- top_clone_data %>%
  group_by(sample, CTaa) %>%
  summarise(count = n(), .groups = 'drop')

clone_order <- top_clone_data %>%
  group_by(CTaa) %>%
  summarise(total = n(), .groups = 'drop') %>%
  arrange(desc(total)) %>%
  pull(CTaa)

clone_counts$CTaa <- factor(clone_counts$CTaa, levels = clone_order)

ggplot(clone_counts, aes(x = CTaa, y = count, fill = sample)) +
  geom_bar(stat = "identity", position = "stack") +  # stacked bars
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  labs(
    title = "Top 100 Expanded CTaa Clones Across Sample Groups",
    x = "CTaa Clone",
    y = "Count",
    fill = "Sample Group"
  )


#Figure S5D - TRBV gene usage in expanded clones
all_tcrs <- all_tcrs %>%
  mutate(TRBV = str_extract(CTgene, "TRBV[^_]+")) %>%
  filter(!is.na(TRBV))

top_clones <- all_tcrs %>%
  group_by(CTaa) %>%
  summarise(freq = n()) %>%
  arrange(desc(freq)) %>%
  slice_head(n = 10) %>%
  pull(CTaa)

top_clone_data <- all_tcrs %>%
  filter(CTaa %in% top_clones)

top_clone_data %>%
  count(TRBV) %>%
  ggplot(aes(x = reorder(TRBV, -n), y = n)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "TRBV Usage in Top 10 Expanded Clones",
       x = "TRBV Gene", y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

get_trbv_usage_fixed <- function(df, sample_name) {
  if (!all(c("chain", "productive", "v_gene") %in% colnames(df))) {
    message("Skipping ", sample_name, ": required columns not found.")
    return(NULL)
  }
  
  df %>%
    mutate(
      productive = tolower(as.character(productive)) == "true"  # normalize to logical
    ) %>%
    filter(chain == "TRB", productive == TRUE) %>%
    filter(!is.na(v_gene)) %>%
    mutate(TRBV = v_gene) %>%
    count(TRBV) %>%
    mutate(sample = sample_name)
}

trbv_usage_list <- mapply(get_trbv_usage_fixed, 
                          df = contig_list, 
                          sample_name = names(contig_list), 
                          SIMPLIFY = FALSE)

trbv_usage_list <- Filter(Negate(is.null), trbv_usage_list)

trbv_usage_df <- bind_rows(trbv_usage_list)

ggplot(trbv_usage_df, aes(x = TRBV, y = n, fill = sample)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "TRBV Gene Usage by Sample Group",
       x = "TRBV Gene", y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

get_top10_trbv_per_group <- function(df, sample_name) {
  # Make sure productive and chain columns exist and normalize productive
  if (!all(c("chain", "productive", "v_gene", "cdr3") %in% colnames(df))) {
    message("Skipping ", sample_name, ": required columns missing.")
    return(NULL)
  }
  
  df <- df %>%
    mutate(productive = tolower(as.character(productive)) == "true")
  

  df_trb <- df %>%
    filter(chain == "TRB", productive == TRUE, !is.na(cdr3))
  

top_clones <- df_trb %>%
   count(cdr3) %>%
   arrange(desc(n)) %>%
   slice_head(n = 10) %>%
   pull(cdr3)
  
 Filter to only top 10 clones
  df_top <- df_trb %>%
    filter(cdr3 %in% top_clones)
  
 Extract TRBV and count usage
  trbv_usage <- df_top %>%
    filter(!is.na(v_gene)) %>%
    mutate(TRBV = v_gene) %>%
    count(TRBV) %>%
    mutate(sample = sample_name)
  
  return(trbv_usage)
}

trbv_top10_list <- mapply(get_top10_trbv_per_group,
                          df = contig_list,
                          sample_name = names(contig_list),
                          SIMPLIFY = FALSE)

trbv_top10_list <- Filter(Negate(is.null), trbv_top10_list)

trbv_top10_df <- bind_rows(trbv_top10_list)

ggplot(trbv_top10_df, aes(x = TRBV, y = n, fill = sample)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "TRBV Usage in Top 10 Clones per Group",
       x = "TRBV Gene", y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#Figure 5E-J - Upstream file processing, QC, and normalization
contigs <- read.csv("filtered_contig_annotations.csv")
seurat_JA41 = CreateSeuratObject(counts = data_JA41$`Gene Expression`)
seurat_JA42 = CreateSeuratObject(counts = data_JA42$`Gene Expression`)

seurat_JA_all <- merge(seurat_JA41, y = c(seurat_JA42), add.cell.ids = c("JA41", "JA42"))

seurat_JA41[['Protein']] = CreateAssayObject(counts = data_JA41$`Antibody Capture`)
seurat_JA42[['Protein']] = CreateAssayObject(counts = data_JA42$`Antibody Capture`)

seurat_JA41 <- subset(seurat_JA41, nFeature_RNA > 200) 
seurat_JA41 <- NormalizeData(seurat_JA41)
seurat_JA41 <- FindVariableFeatures(seurat_JA41)
seurat_JA41 <- ScaleData(seurat_JA41)
seurat_JA41 <- RunPCA(seurat_JA41, features = VariableFeatures(seurat_JA41))
seurat_JA41 <- FindNeighbors(seurat_JA41, dims = 1:10) 
seurat_JA41 <- FindClusters(seurat_JA41, resolution = 0.5) 

seurat_JA42 <- subset(seurat_JA42, nFeature_RNA > 200) 
seurat_JA42 <- NormalizeData(seurat_JA42)
seurat_JA42 <- FindVariableFeatures(seurat_JA42)
seurat_JA42 <- ScaleData(seurat_JA42)
seurat_JA42 <- RunPCA(seurat_JA42, features = VariableFeatures(seurat_JA41))
seurat_JA42 <- FindNeighbors(seurat_JA42, dims = 1:10)
seurat_JA42 <- FindClusters(seurat_JA42, resolution = 0.5) 


seurat_JA41 <- NormalizeData(seurat_JA41, assay = "Protein", normalization.method = "CLR")
seurat_JA42 <- NormalizeData(seurat_JA42, assay = "Protein", normalization.method = "CLR")

seurat_JA41 <- HTODemux(seurat_JA41, assay = "Protein", positive.quantile = 0.99)
seurat_JA42 <- HTODemux(seurat_JA42, assay = "Protein", positive.quantile = 0.99)

table(seurat_JA41$hash.ID)
table(seurat_JA42$hash.ID)

HTOHeatmap(seurat_JA41, assay = "Protein")
HTOHeatmap(seurat_JA42, assay = "Protein")

seurat_JA41@meta.data$orig.ident.JA <- "JA41.N.neg"
seurat_JA42@meta.data$orig.ident.JA <- "JA42.N.pos"

#Demultiplexing
seurat_JA41.Spleen <- subset(seurat_JA41, idents = "CD45-MHCI-TotalSeqC")  
Idents(object = seurat_JA41.Spleen) <- "Spleen"
seurat_JA41.Spleen@meta.data$orig.ident <- "Spleen"
seurat_JA41.Kidney <- subset(seurat_JA41, idents = "CD45-MHCI-TotalSeqC.1")
Idents(object = seurat_JA41.Kidney) <- "Kidney"
seurat_JA41.Kidney@meta.data$orig.ident <- "Kidney"
seurat_JA41.rLN <- subset(seurat_JA41, idents = "CD45-MHCI-TotalSeqC.2")
Idents(object = seurat_JA41.rLN) <- "rLN"
seurat_JA41.rLN@meta.data$orig.ident <- "rLN"

seurat_JA42.Spleen <- subset(seurat_JA42, idents = "CD45-MHCI-TotalSeqC")  
Idents(object = seurat_JA42.Spleen) <- "Spleen"
seurat_JA42.Spleen@meta.data$orig.ident <- "Spleen"
seurat_JA42.Kidney <- subset(seurat_JA42, idents = "CD45-MHCI-TotalSeqC.1")
Idents(object = seurat_JA42.Kidney) <- "Kidney"
seurat_JA42.Kidney@meta.data$orig.ident <- "Kidney"
seurat_JA42.rLN <- subset(seurat_JA42, idents = "CD45-MHCI-TotalSeqC.2")
Idents(object = seurat_JA42.rLN) <- "rLN"
seurat_JA42.rLN@meta.data$orig.ident <- "rLN"

seurat_singlet_JA41 <- merge(seurat_JA41.Kidney, y = c(seurat_JA41.Spleen, seurat_JA41.rLN),project = "all")
seurat_singlet_JA42 <- merge(seurat_JA42.Kidney, y = c(seurat_JA42.Spleen, seurat_JA42.rLN),project = "all")

seurat_singlet_JA41 <- JoinLayers(seurat_singlet_JA41)
seurat_singlet_JA42 <- JoinLayers(seurat_singlet_JA42)

seurat_JA_all <- merge(seurat_singlet_JA41, y = c(seurat_singlet_JA42), add.cell.ids = c("JA41", "JA22"), 
                    project = "seurat_CD4")

seurat_CD4 <- merge(seurat_singlet_JA41, y = c(seurat_singlet_JA42), add.cell.ids = c("JA41", "JA22"), 
                    project = "seurat_CD4")

seurat_CD4[['RNA']]
seurat_CD4[['Protein']]

seurat_CD4[["percent.mt"]] <- PercentageFeatureSet(seurat_CD4, pattern = "^mt-")
VlnPlot(seurat_CD4, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"),ncol = 3)
seurat_CD4 <- subset(seurat_CD4, subset = nFeature_RNA > 800 & nFeature_RNA < 4000 & percent.mt < 3)

seurat_CD4 <- NormalizeData(seurat_CD4)
seurat_CD4 <- FindVariableFeatures(seurat_CD4)
seurat_CD4 <- ScaleData(seurat_CD4)
seurat_CD4 <- RunPCA(seurat_CD4)
seurat_CD4 <- FindNeighbors(seurat_CD4, dims = 1:20, reduction = "pca")
seurat_CD4 <- FindClusters(seurat_CD4, resolution = 1, cluster.name = "unintegrated_clusters")

seurat_CD4  <- RunUMAP(seurat_CD4 , dims = 1:20, reduction = "pca", reduction.name = "umap.unintegrated")
DimPlot(seurat_CD4 , reduction = "umap.unintegrated", group.by = c("orig.ident", "orig.ident.JA", "seurat_clusters"))

seurat_CD4 <- IntegrateLayers(object = seurat_CD4, method = CCAIntegration, orig.reduction = "pca", new.reduction = "integrated.cca",
                              verbose = FALSE)

seurat_CD4[["RNA"]] <- JoinLayers(seurat_CD4[["RNA"]])

seurat_CD4 <- FindNeighbors(seurat_CD4, dims = 1:15, reduction = "integrated.cca")
seurat_CD4 <- FindClusters(seurat_CD4, resolution = 0.5)

seurat_CD4  <- RunUMAP(seurat_CD4 , dims = 1:15, reduction = "integrated.cca")

#Figure S5E-F - Clustering by tissue identity and gene expression
DimPlot(seurat_CD4 , reduction = "umap", group.by = c("orig.ident.JA", "seurat_clusters"))
DimPlot(seurat_CD4 , reduction = "umap", group.by = c("orig.ident", "seurat_clusters"))

seurat_singlet.allmarkers <- FindAllMarkers(seurat_CD4)
seurat_singlet.allmarkers %>% group_by(cluster) %>% top_n(n = 2, wt = avg_log2FC)


#Figure S5G - Gene expression of cluster-defining markers
dotplot_genes <- c('Tcf7', 'Sell', 'Ccr7', 'Il7r', 'Tbx21', 'Bcl6', 'Gata3', 'Foxp3', 'Pdcd1', 'Mki67', 'Cxcr5', 'Cxcr6', 'Ifng', 'Il21', 'Il10')
dotplot <- DotPlot(seurat_CD4, features = dotplot_genes, group.by = 'seurat_clusters', dot.scale = 12)
dotplot

#Figure S5H-J - TCR file processing and combination
contigs.41 <- read.csv("filtered_contig_annotations_JA41.csv")
contigs.42 <- read.csv("filtered_contig_annotations_JA42.csv")

contig.list.41 <- createHTOContigList(contigs.41, seurat_singlet_JA41, group.by = "Protein_maxID")
contig.list.42 <- createHTOContigList(contigs.42, seurat_singlet_JA42, group.by = "Protein_maxID")

contig_Kidney_N.neg <- read.csv("filtered_contig_annotations_JA41_Kidney.csv")
contig_Spleen_N.neg <- read.csv("filtered_contig_annotations_JA41_Spleen.csv")
contig_rLN_N.neg <- read.csv("filtered_contig_annotations_JA41_rLN.csv")
contig_Kidney_N.pos <- read.csv("filtered_contig_annotations_JA42_Kidney.csv")
contig_Spleen_N.pos <- read.csv("filtered_contig_annotations_JA42_Spleen.csv")
contig_rLN_N.pos <- read.csv("filtered_contig_annotations_JA42_rLN.csv")

contig_Kidney <- rbind(contig_Kidney_N.pos, contig_Kidney_N.neg)
contig_Spleen <- rbind(contig_Spleen_N.pos, contig_Spleen_N.neg)
contig_rLN <- rbind(contig_rLN_N.pos, contig_rLN_N.neg)

contig_list <- list(contig_Kidney, contig_Spleen, contig_rLN)

combined <- combineTCR(contig_list, 
                       samples = c("Kidney", "Spleen", "rLN"))

#Figure S5H - Clonal expansion by tissue
plot <- clonalCompare(
  combined,
  top.clones = 7,
  samples = c("rLN", "Spleen", "Kidney"),
  cloneCall = "aa",
  graph = "alluvial"
)

plot <- plot + scale_x_discrete(limits = c("rLN", "Spleen", "Kidney"))

plot <- plot + 
  scale_fill_manual(values = c("#F3756D", "#E88625", "#D29329", "#B59F31", "#92AB3C", "#5FB346", "#28B34B", "#2CB673", "#2CB99C", "#19BDC2", "#05B9E3", "#3FA7DE", "#6F94CD", "#9987BF", "#B47BB5", "#E66AA8", "#F0689A"))

print(plot)

#Figure S5I - Chord diagram
circles <- getCirclize(combined, 
                       group.by = "ident")
grid.cols <- scales::hue_pal()(length(unique(seurat@active.ident)))
names(grid.cols) <- levels(seurat@active.ident)

circlize::chordDiagram(circles, directional =2, 
                       self.link = 2, 
                       grid.col = grid.cols)

#Figure S5J - Morisita-Horn index
clonalOverlap(combined, 
              cloneCall = "CTaa", 
              method = "morisita")


#Figures S5M-N - Nur77-eGFP CD8 TCR clonality analysis, requires output from Figure 5.
#Figure S5M - Gini index by tissue and eGFP expression
clonalDiversity(combined, cloneCall = "CTaa", chain = "both", metrics = c("gini", "shannon"))

combined_df <- map2_dfr(combined, names(combined), ~mutate(.x, sample = .y))

combined_df <- combined_df %>%
  mutate(Group = case_when(
    grepl("Kidney", sample) & grepl("N\\.neg", sample) ~ "Kidney.N.neg",
    grepl("Kidney", sample) & grepl("N\\.pos", sample) ~ "Kidney.N.pos",
    grepl("Spleen", sample) & grepl("N\\.neg", sample) ~ "Spleen.N.neg",
    grepl("Spleen", sample) & grepl("N\\.pos", sample) ~ "Spleen.N.pos",
    grepl("rLN", sample) & grepl("N\\.neg", sample) ~ "rLN.N.neg",
    grepl("rLN", sample) & grepl("N\\.pos", sample) ~ "rLN.N.pos",
    TRUE ~ "Other"
  ))

gini_by_group <- combined_df %>%
  filter(!is.na(CTaa)) %>%
  group_by(Group) %>%
  summarise(
    gini = Gini(table(CTaa))
  )

print(gini_by_group)

ggplot(gini_by_group, aes(x = Group, y = gini, fill = Group)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  ylab("Gini Coefficient") +
  xlab("Tissue Type") +
  ggtitle("Clonal Diversity by Gini Index") +
  scale_y_continuous(limits = c(0, 0.7))

#Figure S5N - TRBV gene usage in expanded clones by eGFP expression
clonalCompare(combined, top.clones = 4, 
              sample = c("Kidney.N.neg", "Kidney.N.pos", "Spleen.N.neg", "Spleen.N.pos", "rLN.N.neg", "rLN.N.pos"), 
              cloneCall="CTaa", 
              graph = "alluvial")

plot <- clonalCompare(combined, top.clones = 5, 
              sample = c("Kidney.N.neg", "Kidney.N.pos", "Spleen.N.neg", "Spleen.N.pos", "rLN.N.neg", "rLN.N.pos"), 
              cloneCall="CTaa", 
              graph = "alluvial")

plot <- plot + scale_x_discrete(limits = c("rLN.N.neg", "rLN.N.pos", "Spleen.N.neg", "Spleen.N.pos", "Kidney.N.neg", "Kidney.N.pos"))

plot <- plot + 
  scale_fill_manual(values = c("#F3756D", "#E88625", "#D29329", "#B59F31", "#92AB3C", "#5FB346", "#28B34B", "#2CB673", "#2CB99C", "#19BDC2", "#05B9E3", "#3FA7DE", "#6F94CD", "#9987BF", "#B47BB5", "#E66AA8", "#F0689A"))

print(plot)


